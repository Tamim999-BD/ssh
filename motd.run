#!/bin/bash
# SKNODES Advanced MOTD Installer - Professional Server Dashboard

echo "ğŸ”§ Installing SKNODES Professional MOTD..."

# Disable default MOTD messages
chmod -x /etc/update-motd.d/* 2>/dev/null

# Create professional stats MOTD script
cat << 'EOF' > /etc/update-motd.d/00-sknodes
#!/bin/bash

# Color Definitions
CYAN="\e[38;5;45m"
GREEN="\e[38;5;82m"
YELLOW="\e[38;5;220m"
BLUE="\e[38;5;51m"
PURPLE="\e[38;5;141m"
RED="\e[38;5;203m"
WHITE="\e[38;5;255m"
RESET="\e[0m"
BOLD="\e[1m"

# Function to get system stats
get_stats() {
    # CPU Load (1-min average)
    LOAD=$(uptime | awk -F 'load average:' '{ print $2 }' | awk '{ print $1 }')
    
    # Memory Usage
    MEM_TOTAL=$(free -m | awk '/Mem:/ {print $2}')
    MEM_USED=$(free -m | awk '/Mem:/ {print $3}')
    MEM_PERC=$((MEM_USED * 100 / MEM_TOTAL))
    
    # Disk Usage
    DISK_USED=$(df -h / | awk 'NR==2 {print $3}')
    DISK_TOTAL=$(df -h / | awk 'NR==2 {print $2}')
    DISK_PERC=$(df -h / | awk 'NR==2 {print $5}' | tr -d '%')
    
    # Other stats
    PROC=$(ps aux | wc -l)
    USERS=$(who | wc -l)
    IP=$(hostname -I | awk '{print $1}')
    UPTIME=$(uptime -p | sed 's/up //')
    OS=$(grep PRETTY_NAME /etc/os-release | cut -d'"' -f2 2>/dev/null || uname -o)
    KERNEL=$(uname -r)
    CPU_CORES=$(nproc 2>/dev/null || echo "N/A")
}

# Function to display progress bar
progress_bar() {
    local value=$1
    local max=100
    local bar_length=20
    local filled=$((value * bar_length / max))
    local empty=$((bar_length - filled))
    
    printf "["
    for ((i=0; i<filled; i++)); do printf "â–“"; done
    for ((i=0; i<empty; i++)); do printf "â–‘"; done
    printf "] %s%%" "$value"
}

# Get stats
get_stats

# Header with SKNODES ASCII Art
echo -e "${CYAN}"
echo -e "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo -e "â”‚                                                                      â”‚"
echo -e "â”‚  â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—â–‘â–‘â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—â–‘â–‘â–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—           â”‚"
echo -e "â”‚  â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘â–‘â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•           â”‚"
echo -e "â”‚  â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•â•â–‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘           â”‚"
echo -e "â”‚  â–‘â•šâ•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â–‘â–‘â–‘â•šâ•â•â•â–ˆâ–ˆâ•—           â”‚"
echo -e "â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–‘â•šâ–ˆâ–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•           â”‚"
echo -e "â”‚  â•šâ•â•â•â•â•â•â–‘â•šâ•â•â–‘â–‘â•šâ•â•â•šâ•â•â–‘â–‘â•šâ•â•â•â–‘â•šâ•â•â•â•â•â–‘â•šâ•â•â•â•â•â•â–‘â•šâ•â•â•â•â•â•â•â•šâ•â•â•â•â•â•â–‘           â”‚"
echo -e "â”‚                                                                      â”‚"
echo -e "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${RESET}"

echo -e "${GREEN}${BOLD}   âš¡ SKNODES Professional Server Dashboard${RESET}"
echo -e "${WHITE}   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${RESET}\n"

# System Information
echo -e "${BLUE}${BOLD}ğŸ“‹ SYSTEM OVERVIEW${RESET}"
echo -e "${WHITE}   Timestamp:${RESET} $(date '+%Y-%m-%d %H:%M:%S %Z')"
echo -e "${WHITE}   Server IP:${RESET} ${YELLOW}${IP}${RESET}"
echo -e "${WHITE}   Hostname: ${RESET} $(hostname -f 2>/dev/null || hostname)"
echo -e "${WHITE}   OS:       ${RESET} ${OS}"
echo -e "${WHITE}   Kernel:   ${RESET} ${KERNEL}"
echo -e "${WHITE}   Uptime:   ${RESET} ${UPTIME}\n"

# Resource Utilization
echo -e "${BLUE}${BOLD}ğŸ“Š RESOURCE UTILIZATION${RESET}"

# CPU Load
echo -e "${WHITE}   CPU Load (1-min):${RESET}"
echo -e "   ${YELLOW}â†³${RESET} ${LOAD} ${WHITE}[Active Cores: ${CPU_CORES}]${RESET}"

# Memory Usage with Progress Bar
echo -e "${WHITE}   Memory Usage:${RESET}"
echo -e "   ${YELLOW}â†³${RESET} ${MEM_USED}MB / ${MEM_TOTAL}MB"
echo -e "     $(progress_bar ${MEM_PERC})"

# Disk Usage with Progress Bar
echo -e "${WHITE}   Disk Usage (/):${RESET}"
echo -e "   ${YELLOW}â†³${RESET} ${DISK_USED} / ${DISK_TOTAL}"
echo -e "     $(progress_bar ${DISK_PERC})"

# System Activity
echo -e "\n${BLUE}${BOLD}ğŸ“ˆ SYSTEM ACTIVITY${RESET}"
echo -e "${WHITE}   Active Processes:${RESET} ${PROC}"
echo -e "${WHITE}   Logged-in Users: ${RESET} ${USERS}"
echo -e "${WHITE}   Active Services: ${RESET} $(systemctl list-units --state=running --type=service 2>/dev/null | grep -c "loaded units")"

# Network Status
echo -e "\n${BLUE}${BOLD}ğŸŒ NETWORK STATUS${RESET}"
echo -e "${WHITE}   Public IP:       ${RESET} $(curl -s ifconfig.me 2>/dev/null || echo "Not available")"
echo -e "${WHITE}   SSH Connections: ${RESET} $(ss -t state established sport = :ssh 2>/dev/null | wc -l)"
echo -e "${WHITE}   Open Ports:      ${RESET} $(ss -tuln 2>/dev/null | grep -c LISTEN)"

# Quick Commands Reference
echo -e "\n${BLUE}${BOLD}âš™ï¸  QUICK COMMANDS${RESET}"
echo -e "${WHITE}   System Info:    ${RESET}${GREEN}htop${RESET}, ${GREEN}nmon${RESET}, ${GREEN}neofetch${RESET}"
echo -e "${WHITE}   Network Tools:  ${RESET}${GREEN}vnstat${RESET}, ${GREEN}iftop${RESET}, ${GREEN}nload${RESET}"
echo -e "${WHITE}   Security:       ${RESET}${GREEN}fail2ban-client status${RESET}"
echo -e "${WHITE}   Updates:        ${RESET}${GREEN}apt update && apt upgrade${RESET}"

# Security Status (if available)
if command -v fail2ban-client &> /dev/null; then
    echo -e "\n${BLUE}${BOLD}ğŸ”’ SECURITY STATUS${RESET}"
    echo -e "${WHITE}   Fail2Ban:       ${RESET}$(fail2ban-client status sshd 2>/dev/null | grep "Currently banned" | awk '{print $4}') banned IPs"
fi

# Footer
echo -e "\n${CYAN}${BOLD}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${RESET}"
echo -e "${WHITE}   ğŸŒ Website:     ${BLUE}https://sknodes.com${RESET}"
echo -e "${WHITE}   ğŸ“§ Support:     ${BLUE}support@sknodes.com${RESET}"
echo -e "${WHITE}   ğŸ’¼ Enterprise:  ${BLUE}enterprise@sknodes.com${RESET}"
echo -e "${CYAN}${BOLD}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${RESET}"

echo -e "\n${GREEN}${BOLD}   âš¡ Professional Infrastructure â€¢ Secure â€¢ Scalable â€¢ Reliable${RESET}"
echo -e "${YELLOW}   Last updated: $(date '+%Y-%m-%d %H:%M')${RESET}"
EOF

# Make script executable
chmod +x /etc/update-motd.d/00-sknodes

# Test the MOTD
echo -e "${GREEN}${BOLD}âœ… SKNODES MOTD Installed Successfully!${RESET}"
echo -e "${YELLOW}â¡ Please reconnect SSH to see the new professional dashboard${RESET}"
echo -e "${CYAN}   You can also run: ${WHITE}run-parts /etc/update-motd.d/${RESET}\n"

# Display preview
echo -e "${BLUE}${BOLD}ğŸ“‹ Preview of your new MOTD:${RESET}"
echo -e "${WHITE}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${RESET}"
/etc/update-motd.d/00-sknodes
